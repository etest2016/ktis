<%
//******************************************************************************
//   프로그램 : ans_mark_dan.jsp
//   모 듈 명 : 단답형 수동채점
//   설    명 : 단답형 수동채점(미채점자 리스트)
//   테 이 블 : 
//   자바파일 : qmtm.tman.answer.AnswerMark, qmtm.tman.answer.AnswerMarkBean
//   작 성 일 : 2008-06-05
//   작 성 자 : 이테스트 석준호
//   수 정 일 : 
//   수 정 자 : 
//	 수정사항 : 
//******************************************************************************
%>

<%@ page contentType="text/html; charset=euc-kr" %>
<%@ page import="qmtm.*, qmtm.common.*, qmtm.tman.answer.*, java.sql.*" %>

<%
	response.setDateHeader("Expires", 0);
	request.setCharacterEncoding("euc-kr");

    int i_tot_cnt  = 0;

	String id_exam = request.getParameter("id_exam");
	if (id_exam == null) { id_exam= ""; } else { id_exam = id_exam.trim(); }

	String id_q = request.getParameter("id_q");
	if (id_q == null) { id_q= ""; } else { id_q = id_q.trim(); }
	
	if (id_exam.length() == 0 || id_q.length() == 0) {
		out.println(ComLib.getParameterChk("back"));

	    if(true) return;
	}

	ExamInfoBean info = null;
	
	try {
		info = ExamInfo.getBean(id_exam);
	}
    catch (Exception ex) {
        out.println(ComLib.getExceptionMsg(ex, "back"));

		if(true) return;
	}

	int qcount = info.getQcount();
	
	AnswerMarkDanBean[] beans = null;

	try {
		beans = AnswerMarkDan.getBeans(id_exam, Long.parseLong(id_q));
	} catch(Exception ex) {
		out.println(ComLib.getExceptionMsg(ex, "back"));

		if(true) return;
	}

	if(beans == null || beans.length == 0) {
		i_tot_cnt = 0;
	} else {
		i_tot_cnt = beans.length;
	}

	out.println(i_tot_cnt);

	if (i_tot_cnt < 1) {
%>
	<script language="javascript">
		alert('채점이 되지 않았습니다. 채점 처리를 하여야 수동채점이 가능 합니다.');
		window.close();
	</script>
<%
		if(true) return;

    } else {
		String strQuestion = beans[0].getQ();
		String strCa = "";
		if(beans[0].getCa() == null || beans[0].getCa().equals("")) {
			strCa = "";
		} else {
			strCa = beans[0].getCa().trim();
		}

        double lngAllotting = beans[0].getAllotting();

       	String[] ArrUserid = new String[i_tot_cnt];
        String[] ArrAnswer = new String[i_tot_cnt];
		//String[] ArrName = new String[i_tot_cnt];
		String[] tmpOX = new String[i_tot_cnt];
		String[] pointsTmp = new String[i_tot_cnt];
		String[] tmpAns = new String[i_tot_cnt];
		String strTemp = "";
		int qindex = 0;
		String YN_Points;
		String tmpPoints;

	    //시험지 마다 같은 문항의 배점을 달리 할 수 있으므로 배점을 가지고 다녀야 한다
	    //현재는 고려하지 않도록 코딩한다
	    Double[] ArrAllotting = new Double[i_tot_cnt];

		for (int i = 0; i < i_tot_cnt; i++) {
		// 채점이 되지 않은 응시자..
		// 수동 채점 목록에서 제외한다

		String imsi_points = "";
        
		if(beans[i].getOxs() == null || beans[i].getOxs().equals("")) {
           out.println("<br>&nbsp;&nbsp;&nbsp;&nbsp;<b><font color=blue>" + beans[i].getUserid() + ") 응시자가 채점이 되지 않았습니다. 채점 처리를 하여야 수동채점이 가능 합니다</font></b>");	
		         ArrUserid[i] = ""; 
		      } else{
			        qindex = beans[i].getNr_q() - 1;

			        tmpOX = beans[i].getOxs().split(QmTm.Q_GUBUN_re,-1);
					
					
			        YN_Points = "N";

				 if(tmpOX[qindex].equals("X") && YN_Points.equals("N")) {
				       ArrUserid[i] = beans[i].getUserid();
				    
					if(!beans[i].getAnswers().equals("")) {
					      tmpAns = beans[i].getAnswers().split(QmTm.Q_GUBUN_re, -1);
					      ArrAnswer[i] = tmpAns[qindex];
				    } else {
					      ArrAnswer[i] = "";
				    }

			     } else {
				    ArrUserid[i] = "";
			     }

		     }
	    } // for 문 종료
%>

<html>
<head>
<title> :: 단답형문항 채점 :: </title>
<link rel="StyleSheet" href="../../css/style.css" type="text/css">

<script language="javascript">
	function ftnscore() {
		var resultwin;
		var flag = "N";
		
		if (document.frmData.allscore.value == "") {
			alert("점수를 입력하지 않았습니다");
			document.frmData.allscore.focus();
			return;
		}

		if (document.frmData.selectid.length) {
			for (i=0; i <= document.frmData.selectid.length -1; i++) {
				if (document.frmData.selectid[i].checked == true) {
					flag = "Y";
					break;
				}
			}
			
			if (flag == "N") {
				alert("선택된 응시자가 없습니다");
				return;
			}
		}
		else {
			if (document.frmData.selectid.checked == false) {
				alert("선택된 응시자가 없습니다");
				return;
			}
		}

		if (document.frmData.allscore.value > <%= lngAllotting %>) { alert("문제의 배점은 " + <%= lngAllotting %> + "점 입니다\n배점보다 점수를 높게 입력할 수 없습니다");			return;		}		
		if (confirm("점수를 부여받은 학생은 오답 리스트에서 제외 됩니다\n선택한 응시자에게 점수를 주시겠습니까?") == true) {
			resultwin = window.open("", "markresult", "width=300, height=200, scrollbars=no,resizable=yes");
			resultwin.focus();
			
			document.frmData.target = "markresult";
			document.frmData.action = "ans_mark_dan_ok.jsp";
			document.frmData.submit();
		}
	}
</script>

<script type="text/javascript" src="../../js/tablesort.js"></script>
</head>

<body>

	<table width="70%" cellpadding="0" cellspacing="0" border="0" align="center">
		<tr>
			<td colspan="2" align="right" height="40px;" valign="top"><img src="../../images/bt2_close.gif" style="cursor: hand;" onclick="window.close();"></td>
		</tr>
		<tr>
			<td colspan="2" class="f1">■ 단답형 채점확인 및 수정</td>
			<!--<td align="right"><b><a href="profq1.htm" target="_self"><font color="03601F">문제목록으로 돌아가기→</font></a></b></td>-->
		</tr>
		<tr>
			<td colspan="2" valign="top">

				<table width="100%" border="0" cellspacing="0" cellpadding="0" align="center" id="tableD" style="margin-top: 5px; margin-bottom: 20px;">
					<tr> 
						<td id="left" width="12%"><li>문항코드</td>
						<td width="14%"><%= id_q %></td>
						<td id="left" width="12%"><li>정답</td>
						<td width="40%">
							"☞" <%= strCa.replaceAll(QmTm.LIKE_GUBUN_re, " 또는 ").replaceAll(QmTm.OR_GUBUN_re, " , ") %>
						</td>
						<td id="left"  width="12%"><li>배점</td>
						<td width="10%"><font color="red"><b><%= lngAllotting %></b></font> 점</td>
					</tr>
					<tr> 
						<td id="left"><li>문제</td>
						<td colspan="5"><%= strQuestion %></td>
					</tr>
							
				</table>

			</td>
		</tr>
		<tr>
			<td class="f1">
				▣ 미채점자 리스트
			</td>
			<td align="right"><font color="blue"><b><a href="ans_mark_dan2.jsp?id_exam=<%= id_exam %>&id_q=<%= id_q %>" onFocus="this.blur()">[채점완료자 리스트로 이동]</a></b></font>
			</td>
		</tr>	

		<tr>
			<td colspan="2">				
				<form name="frmData" method="post">
				<input type="hidden" name="id_exam" value="<%= id_exam %>">
				<input type="hidden" name="id_q" value="<%= id_q %>">

				<table width="100%" border="0" cellspacing="0" cellpadding="0" id="tableA" style="margin-top: 5px;">
					<tr id="sub_title">
						<td colspan="3">
							* 선택한 응시자 점수주기 : <input type="text" class="input" name="allscore" maxlength="5" size="4" style="text-align:right">점 <input type="image" value="확인" name="button" onclick="javascript:ftnscore();" src="../../images/bt_get_statics1_yj1.gif" align="absmiddle">
						</td>
					</tr>
				</table>
				
				<table border="0" cellpadding ="0" cellspacing="0" id="tb1" width="100%" onclick="sortColumn(event)">
				<THEAD>
					<tr id="trTOP1" height="30">
						<td width="50">선택</td>
						<td width="100">아이디▲▼</td>
						<td width="*">제출한 답▲▼</td>
					</tr>
				</THEAD>
					<%
						int i = 0;
						for (int a = 0; a < ArrUserid.length; a++) {
							
							if(ArrUserid[a] != "") {
								i = i + 1;
					%>
					<tr id="trDATA1" align="center" <% if(i%2==0){%>bgcolor="#fafafa"<%}%>>
						<td width="50"><input type="checkbox" name="selectid" value="<%= ArrUserid[a] %>"></td>
						<td width="100">&nbsp;<%= ArrUserid[a].substring(0,ArrUserid[a].length()-2) %>&nbsp;</td>
						<td width="*">&nbsp;<%= ArrAnswer[a].replaceAll(QmTm.LIKE_GUBUN_re, " 또는 ") %>&nbsp;</td>
					</tr>
					<%
							}
						}
					%>
				</table>

				</form>

			</td>
		</tr>
		
	</table>	
</body>
</html>

<%
    }
%>